name: Anonymous Passwordless SSH Server with Bore.pub

on:
  workflow_dispatch:

jobs:
  ssh-server:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # Instalar SSH + Rust
    - name: Install SSH Server and Rust
      run: |
        sudo apt update
        sudo apt install -y openssh-server curl build-essential git

        # Install Rust
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH

    # Instalar bore
    - name: Install Bore CLI
      run: |
        cargo install bore-cli

    # Configurar SSH sem senha
    - name: Configure Passwordless SSH
      run: |
        sudo tee /etc/ssh/sshd_config > /dev/null <<EOF
        Port 22
        Protocol 2
        PasswordAuthentication yes
        PermitEmptyPasswords yes
        PubkeyAuthentication no
        ChallengeResponseAuthentication no
        PermitRootLogin yes
        StrictModes no
        UsePAM no
        EOF

    # Criar usuÃ¡rios sem senha
    - name: Create Passwordless Users
      run: |
        sudo passwd -d root || true

        sudo useradd -m -s /bin/bash topuser || true
        sudo passwd -d topuser

        sudo usermod -aG sudo topuser
        echo 'topuser ALL=(ALL) NOPASSWD: ALL' | sudo tee /etc/sudoers.d/topuser
        sudo chmod 440 /etc/sudoers.d/topuser

    # Start SSH
    - name: Start SSH Server
      run: |
        sudo ssh-keygen -A
        sudo systemctl restart ssh
        sudo ss -tlnp | grep :22 || true

    # Start Bore Tunnel
    - name: Start Bore Tunnel
      run: |
        echo "ðŸš€ Starting bore tunnel..."
        bore local 22 --to bore.pub > bore_output.txt 2>&1 &
        sleep 15

        echo "================ SSH INFO ================"
        cat bore_output.txt
        echo "=========================================="

        # Extrair porta automaticamente
        PORT=$(grep -oE "bore.pub:[0-9]+" bore_output.txt | cut -d: -f2)
        echo "PORT=$PORT" >> $GITHUB_ENV

        echo "=========================================="
        echo "SSH COMMAND:"
        echo "ssh root@bore.pub -p $PORT"
        echo "ssh topuser@bore.pub -p $PORT"
        echo "Senha: ENTER (vazia)"
        echo "=========================================="

        sleep 21600
