name: ROOT SSH CLOUD

on:
  workflow_dispatch:

jobs:
  ssh:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Liberar espaço
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo docker image prune -a -f

      # Instalar pacotes
      - name: Install tools
        run: |
          sudo apt update
          sudo apt install -y openssh-server curl wget git

      # Configurar SSH ROOT
      - name: Setup SSH Root
        run: |
          sudo service ssh start

          # senha root (MUDE)
          echo "root:123456" | sudo chpasswd

          sudo sed -i 's/#PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config
          sudo sed -i 's/#PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config

          sudo service ssh restart

      # Instalar Cloudflare Tunnel
      - name: Install Cloudflared
        run: |
          wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
          chmod +x cloudflared-linux-amd64
          sudo mv cloudflared-linux-amd64 /usr/local/bin/cloudflared

      # Abrir túnel SSH público
      - name: Open SSH Tunnel
        run: |
          echo "================ SSH INFO ================"
          echo "Espere aparecer uma URL cloudflare"
          echo "Depois conecte com:"
          echo "ssh root@URL -p 22"
          echo "Senha: 123456"
          echo "=========================================="

          cloudflared tunnel --url ssh://localhost:22 &
          sleep 21600
